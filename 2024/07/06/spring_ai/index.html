<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringAI 基础使用 | Loong's Blog</title><meta name="author" content="Loong"><meta name="copyright" content="Loong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="¶前言 目前在研究 SpringAI 的使用，我会将学习到的相关知识在这片博客进行整理，方便加深印象以及后期复习，也希望能够帮助看到这篇博客的朋友去学习 SpringAI 的使用方法。 ¶Chat Model 与 Chat Client 文中各样例均使用 Chat Model API，我将SpringAI官网对其与 Chat Client API 的介绍贴至下方，大家可按照需求进行选择。  Cha">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringAI 基础使用">
<meta property="og:url" content="https://gubaleaves.github.io/2024/07/06/spring_ai/index.html">
<meta property="og:site_name" content="Loong&#39;s Blog">
<meta property="og:description" content="¶前言 目前在研究 SpringAI 的使用，我会将学习到的相关知识在这片博客进行整理，方便加深印象以及后期复习，也希望能够帮助看到这篇博客的朋友去学习 SpringAI 的使用方法。 ¶Chat Model 与 Chat Client 文中各样例均使用 Chat Model API，我将SpringAI官网对其与 Chat Client API 的介绍贴至下方，大家可按照需求进行选择。  Cha">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2024-07-06T09:55:00.000Z">
<meta property="article:modified_time" content="2024-09-25T07:55:12.000Z">
<meta property="article:author" content="Loong">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="SpringAI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://gubaleaves.github.io/2024/07/06/spring_ai/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringAI 基础使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-25 15:55:12'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于作者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Loong's Blog"><span class="site-name">Loong's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于作者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringAI 基础使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-06T09:55:00.000Z" title="发表于 2024-07-06 17:55:00">2024-07-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-25T07:55:12.000Z" title="更新于 2024-09-25 15:55:12">2024-09-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringAI 基础使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a class="header-anchor" href="#前言">¶</a>前言</h2>
<p>目前在研究 SpringAI 的使用，我会将学习到的相关知识在这片博客进行整理，方便加深印象以及后期复习，也希望能够帮助看到这篇博客的朋友去学习 SpringAI 的使用方法。</p>
<h2 id="Chat-Model-与-Chat-Client"><a class="header-anchor" href="#Chat-Model-与-Chat-Client">¶</a>Chat Model 与 Chat Client</h2>
<p>文中各样例均使用 <code>Chat Model API</code>，我将SpringAI官网对其与 <code>Chat Client API</code> 的介绍贴至下方，大家可按照需求进行选择。</p>
<blockquote>
<h1><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/chatclient.html">Chat Client API</a></h1>
<p>The <code>ChatClient</code> offers a fluent API for communicating with an AI Model. It supports both a synchronous and reactive programming model.</p>
<p>The fluent API has methods for building up the constituent parts of a <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/prompt.html#_prompt">Prompt</a> that is passed to the AI model as input. The <code>Prompt</code> contains the instructional text to guide the AI model’s output and behavior. From the API point of view, prompts consist of a collection of messages.</p>
<p>The AI model processes two main types of messages: user messages, which are direct inputs from the user, and system messages, which are generated by the system to guide the conversation.</p>
<p>These messages often contain placeholders that are substituted at runtime based on user input to customize the response of the AI model to the user input.</p>
<p>There are also Prompt options that can be specified, such as the name of the AI Model to use and the temperature setting that controls the randomness or creativity of the generated output.</p>
</blockquote>
<blockquote>
<h1><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/chatmodel.html">Chat Model API</a></h1>
<p>The Chat Model API offers developers the ability to integrate AI-powered chat completion capabilities into their applications. It leverages pre-trained language models, such as GPT (Generative Pre-trained Transformer), to generate human-like responses to user inputs in natural language.</p>
<p>The API typically works by sending a prompt or partial conversation to the AI model, which then generates a completion or continuation of the conversation based on its training data and understanding of natural language patterns. The completed response is then returned to the application, which can present it to the user or use it for further processing.</p>
<p>The <code>Spring AI Chat Model API</code> is designed to be a simple and portable interface for interacting with various <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/concepts.html#_models">AI Models</a>, allowing developers to switch between different models with minimal code changes. This design aligns with Spring’s philosophy of modularity and interchangeability.</p>
<p>Also with the help of companion classes like <code>Prompt</code> for input encapsulation and <code>ChatResponse</code> for output handling, the Chat Model API unifies the communication with AI Models. It manages the complexity of request preparation and response parsing, offering a direct and simplified API interaction.</p>
</blockquote>
<h2 id="配置环境"><a class="header-anchor" href="#配置环境">¶</a>配置环境</h2>
<h3 id="Maven-依赖"><a class="header-anchor" href="#Maven-依赖">¶</a>Maven 依赖</h3>
<p>如果使用 Maven 进行项目管理，请在 <em>pom.xml</em> 中添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 仓库定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 依赖管理配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="application-yml-文件配置"><a class="header-anchor" href="#application-yml-文件配置">¶</a>application.yml 文件配置</h3>
<p>主要需要在配置文件 <em>application.yml</em> 中配置好 <code>base-url</code> 以及 <code>api-key</code>，可以前往 OpenAI 官网申请 <code>api-key</code>，但需要海外手机号及海外信用卡，也可以选择国内中转，获取途经不详细介绍。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">ai:</span></span><br><span class="line">    <span class="attr">openai:</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">$&#123;OPENAI_API_KEY&#125;</span>  <span class="comment"># 推荐使用环境变量配置</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.openai.com</span>  <span class="comment"># 默认，需按实际情况修改</span></span><br><span class="line">      <span class="attr">chat:</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">model:</span> <span class="string">gpt-3.5-turbo</span></span><br><span class="line">          <span class="comment"># model: gpt-4o  # 用于图像处理</span></span><br></pre></td></tr></table></figure>
<p>如果有不会配置环境变量的，也可将 <code>api-key</code> 直接放在配置文件中。</p>
<h2 id="快速开始"><a class="header-anchor" href="#快速开始">¶</a>快速开始</h2>
<h3 id="简单对话"><a class="header-anchor" href="#简单对话">¶</a>简单对话</h3>
<p>实例化一个 <code>ChatModel</code> 对象，调用 <code>call()</code> 方法即可，输入参数为 <code>String</code> 类型的 <code>message</code> ，为用户输入的问题，输出也为 <code>String</code> 类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;, defaultValue = &quot;Hello AI, How are you?&quot;)</span> String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.chatModel.call(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样的 AI 只是一个单调且无聊的机器人：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/hello%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h3 id="带提示词对话"><a class="header-anchor" href="#带提示词对话">¶</a>带提示词对话</h3>
<p>我们肯定不会满足于 AI 只是一个冷冰冰的对话助手，那么如何通过提示词让 AI 扮演一个固定的角色呢？可以通过下面这段代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/master&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">master</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;)</span> String message)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">system</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            你是一个算命大师，名叫陈玉楼，负责为客户解答命理相关的内容；</span></span><br><span class="line"><span class="string">            你从不说自己是一个人工智能助手或AI，而是以老夫、老朽等自称</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>);</span><br><span class="line">    <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(system, <span class="keyword">new</span> <span class="title class_">UserMessage</span>(message)));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>List.of()</code> 方法将 <code>SystemMessage</code> 和 <code>UserMessage</code> 类型的信息转化成列表，用来实例化 <code>Prompt</code> 对象。</p>
<p>当 <code>call()</code> 方法传入参数为 <code>Prompt</code> 类型时，它的输出为 <code>ChatResponse</code> 类型，可通过继续调用 <code>.getResult().getOutput().getContent()</code> 方法来将其转化为 <code>String</code> 类型。</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/master%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h3 id="模版对话"><a class="header-anchor" href="#模版对话">¶</a>模版对话</h3>
<p>一些特定情况下，我们需要使用结构化提示词，通过提示词模板，用户只需要输入一些简短的参数即可获得希望的结果，对于这种情况，需要使用到 <code>PromptTemplate</code> 类，<code>PromptTemplate</code> 能够帮助我们创建结构化提示词，是 SpringAI 提示词工程中的关键组件。</p>
<p>例如，我们希望输入电影的种类，获得十个该类别电影的推荐，可以通过下面代码进行实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/popular&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getHistoryMovie</span><span class="params">(<span class="meta">@RequestParam(value = &quot;category&quot;, defaultValue = &quot;科幻&quot;)</span> String category)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;列出你认为世界上最好看的十部&#123;category&#125;电影，带上他们上映的年份&quot;</span>;</span><br><span class="line">    <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(message);</span><br><span class="line">    <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(<span class="string">&quot;category&quot;</span>, category));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了通过定义字符串加载 <code>PromptTemplate</code> 以外，我们还可以以 <code>Resource</code> 的形式，例如，我们可以在项目目录的 <em>/resouces</em> 下创建 <em><a target="_blank" rel="noopener" href="http://prompt.st">prompt.st</a></em>，将刚刚的提示词模板写入到该文件中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;classpath:prompts.st&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Resource promptsResource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/popular&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getHistoryMovieByST</span><span class="params">(<span class="meta">@RequestParam(value = &quot;category&quot;, defaultValue = &quot;科幻&quot;)</span> String category)</span> &#123;</span><br><span class="line">    <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(promptsResource);</span><br><span class="line">    <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(<span class="string">&quot;category&quot;</span>, category));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以获得相同的结果：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/popular%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h3 id="限制输出格式"><a class="header-anchor" href="#限制输出格式">¶</a>限制输出格式</h3>
<p>SpringAI 不仅为我们提供了 <code>PromptTemplate</code> 让我们快速的构建用于输入 AI 的提示词，还为我们提供了 <code>OutputParser</code> 解析器，该解析器可以将 AI 生成的内容解析为 Java Bean 对象。该解析器类似于 ORM 框架中的 Mapper，将 AI 的生成内容映射为 Java 对象。</p>
<p>在 SpringAI 中，<code>OutputParser</code> 接口有三个具体实现类：</p>
<ul>
<li><code>BeanOutputParser</code>：通过让 AI 生成 JSON 格式的文本，然后通过 JSON 反序列化为 Java 对象返回</li>
<li><code>MapOutputParser</code>：与 <code>BeanOutputParser</code> 的功能类似，但会通过 JSON 反序列化为 <code>Map</code> 对象返回</li>
<li><code>ListOutputParser</code>：让 AI 生成以逗号分隔的列表</li>
</ul>
<p>几种实现类的具体使用可以参考下面代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParserController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list_movie&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getHistoryMovie</span><span class="params">(<span class="meta">@RequestParam(value = &quot;category&quot;, defaultValue = &quot;科幻&quot;)</span> String category)</span> &#123;</span><br><span class="line">        <span class="type">ListOutputConverter</span> <span class="variable">listOutputConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListOutputConverter</span>(<span class="keyword">new</span> <span class="title class_">DefaultConversionService</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;列出你认为世界上最好看的十部&#123;category&#125;电影，带上他们上映的年份，并给出推荐理由，&#123;format&#125;&quot;</span>;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(message, Map.of(<span class="string">&quot;category&quot;</span>, category, <span class="string">&quot;format&quot;</span>, listOutputConverter.getFormat()));</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(promptTemplate.createMessage());</span><br><span class="line">        <span class="keyword">return</span> listOutputConverter.convert(<span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/map_movie&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getHistoryMovieByMap</span><span class="params">(<span class="meta">@RequestParam(value = &quot;category&quot;, defaultValue = &quot;科幻&quot;)</span> String category)</span> &#123;</span><br><span class="line">        <span class="type">MapOutputConverter</span> <span class="variable">mapOutputConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapOutputConverter</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;列出你认为世界上最好看的十部&#123;category&#125;电影，带上他们上映的年份，并给出推荐理由，&#123;format&#125;&quot;</span>;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(message, Map.of(<span class="string">&quot;category&quot;</span>, category, <span class="string">&quot;format&quot;</span>, mapOutputConverter.getFormat()));</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(promptTemplate.createMessage());</span><br><span class="line">        <span class="keyword">return</span> mapOutputConverter.convert(<span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/bean_movie&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Movies <span class="title function_">getHistoryMovieByBean</span><span class="params">(<span class="meta">@RequestParam(value = &quot;category&quot;, defaultValue = &quot;科幻&quot;)</span> String category)</span> &#123;</span><br><span class="line">        BeanOutputConverter&lt;Movies&gt; beanOutputConverter = <span class="keyword">new</span> <span class="title class_">BeanOutputConverter</span>&lt;&gt;(Movies.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;列出你认为世界上最好看的十部&#123;category&#125;电影，带上他们上映的年份，并给出推荐理由，&#123;format&#125;&quot;</span>;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(message, Map.of(<span class="string">&quot;category&quot;</span>, category, <span class="string">&quot;format&quot;</span>, beanOutputConverter.getFormat()));</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(promptTemplate.createMessage());</span><br><span class="line">        <span class="keyword">return</span> beanOutputConverter.convert(<span class="built_in">this</span>.chatModel.call(prompt).getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，使用 <code>BeanOutputParser</code> 需要先构建一个实体类（该实体类因篇幅原因不进行展示），将会以实体类的格式进行输出。输出效果以 <em>/map_movie</em> 接口为例：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/movie%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h3 id="知识库"><a class="header-anchor" href="#知识库">¶</a>知识库</h3>
<p>如果我们希望 AI 能够根据我们自己提供的知识来回答一些知识，或者为了扩充 AI 所不了解的内容，我们可以使用构建知识库的方式，最简单的便是将我们提供的知识放入 <em>.txt</em> 文件中，通过以下代码完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StuffController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/prompts/stuff.st&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource promptResource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/docs/stuff.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource stuffResource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StuffController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stuff&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSports</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;, defaultValue = &quot;2024年夏季奥运会有哪些运动项目&quot;)</span> String message, </span></span><br><span class="line"><span class="params">                            <span class="meta">@RequestParam(value = &quot;stuff&quot;, defaultValue = &quot;false&quot;)</span> <span class="type">boolean</span> stuff)</span> &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(promptResource);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;question&quot;</span>, message);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(stuff) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;context&quot;</span>, stuffResource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            map.put(<span class="string">&quot;context&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(map);</span><br><span class="line">        <span class="keyword">return</span> chatModel.call(prompt).getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<em><a target="_blank" rel="noopener" href="http://stuff.st">stuff.st</a></em> 位于 <em>/resources/prompts</em>，其中的内容为：</p>
<figure class="highlight st"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用以下的 context 来回答最后的问题，如果你不知道答案，请说“对不起，我不知道这个问题的答案”</span><br><span class="line">&#123;context&#125;</span><br><span class="line"><span class="type">Question</span>: &#123;question&#125;</span><br></pre></td></tr></table></figure>
<p><em>stuff.txt</em> 位于 <em>/resources/docs</em>，其中的内容为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2024夏季奥运会，共设32个大项329个小项。跟2021奥运会相比，增设了霹雳舞1个大项，减少上届奥运会东道主的棒垒球、空手道两个大项。</span><br><span class="line">32个大项包括：田径、游泳、足球、篮球、排球、乒乓球、羽毛球、体操、网球、手球、曲棍球、高尔夫球、七人制橄榄球、马术、自行车、射击、射箭、举重、击剑、拳击、摔跤、柔道、跆拳道、赛艇、皮划艇、帆船帆板、现代五项、铁人三项、攀岩、冲浪、滑板、霹雳舞。32个大项中，攀岩、冲浪、滑板、霹雳舞是2024夏季奥运会特设比赛项目，其他28个大项是夏季奥运会的常设项目。</span><br><span class="line">有的项目设立了分项，如游泳设游泳、跳水、花样游泳、水球、公开水域5个分项，体操设竞技体操、艺术体操、蹦床3个分项，篮球设篮球、3人篮球2个分项，排球设室内排球、沙滩排球2个分项等。</span><br></pre></td></tr></table></figure>
<p>运行以上程序，如果设置 <code>stuff</code> 为 <code>false</code>，则 AI 会回答 “对不起，我不知道这个问题的答案”；如果将 <code>stuff</code> 设置为 <code>true</code>，AI 将会从提供的知识库中寻找答案，并给出正确的回答：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/stuff%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<p>然而，由于对话有最大 token 的限制，很多场景下我们是无法直接将所有的数据发给 AI 的，一方面在数据量很大的情况下，会突破 token 的限制，另一方面，在不突破 token 限制的情况下也会有不必要的对话费用开销。因此我们如何在花费最少费用的同时又能让 AI 更好的根据我们提供的数据进行回复是一个非常关键的问题。针对这一问题，我们可以采用数据向量化的方式来解决。</p>
<p>当我们将个人数据存储到向量数据库中，在用户想和 AI 发起对话之前，首先从向量数据库中检索一组相似的文档，然后将这些文档作为用户问题的上下文，并与用户的对话一起发送到 AI 模型，从而实现精确性的回复。这种方式称为检索增强生成（<em>RAG</em>）。</p>
<p>向量数据库（<em>Vector Database</em>）是一种特殊类型的数据库，在人工智能应用中发挥着重要作用。在向量数据库中，查询操作与传统的关系数据库不同。它们是执行相似性搜索，而不是精确匹配。当给定向量作为查询时，向量数据库返回与查询向量“相似”的向量。通过这种方式，我们就能将个人的数据与AI模型进行集成。</p>
<p>常见的向量数据库有 Chroma、Pgvector、Redis、Neo4j 等。本篇文章将使用 <code>SimpleVectorStore</code> 类构建向量数据库，具体的构建方法通过以下代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RagConfiguration.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/docs/rag.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource rag;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;vector.json&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String vectorStoreName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SimpleVectorStore <span class="title function_">simpleVectorStore</span><span class="params">(EmbeddingModel embeddingModel)</span> &#123;</span><br><span class="line">        <span class="type">SimpleVectorStore</span> <span class="variable">simpleVectorStore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleVectorStore</span>(embeddingModel);</span><br><span class="line">        <span class="type">File</span> <span class="variable">vectorStoreFile</span> <span class="operator">=</span> getVectorStoreFile();</span><br><span class="line">        <span class="keyword">if</span> (vectorStoreFile.exists()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Vector Store file exists&quot;</span>);</span><br><span class="line">            simpleVectorStore.load(vectorStoreFile);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Vector Store file does not exist, loading documents&quot;</span>);</span><br><span class="line">            <span class="type">TextReader</span> <span class="variable">textReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextReader</span>(rag);</span><br><span class="line">            textReader.getCustomMetadata().put(<span class="string">&quot;filename&quot;</span>, <span class="string">&quot;rag.txt&quot;</span>);</span><br><span class="line">            List&lt;Document&gt; documents = textReader.get();</span><br><span class="line">            <span class="type">TokenTextSplitter</span> <span class="variable">tokenTextSplitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenTextSplitter</span>();</span><br><span class="line">            List&lt;Document&gt; apply = tokenTextSplitter.apply(documents);</span><br><span class="line"></span><br><span class="line">            simpleVectorStore.add(apply);</span><br><span class="line">            simpleVectorStore.save(vectorStoreFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> simpleVectorStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getVectorStoreFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;src&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="string">&quot;resources&quot;</span>, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> path.toFile().getAbsolutePath() + <span class="string">&quot;/&quot;</span> + vectorStoreName;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(absolutePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得的 JSON 文件位于 <em>src/main/resources/data</em> 目录下，文件内容如图所示：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/json%E5%86%85%E5%AE%B9rag.png" alt="获得向量文件的内容"></p>
<p>通过构建向量数据库，我们便可以将向量数据库作为 AI 的知识，进行AI 的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VectorStore vectorStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/prompts/rag.st&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource ragPromptTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RagController</span><span class="params">(ChatModel chatModel, VectorStore vectorStore)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">        <span class="built_in">this</span>.vectorStore = vectorStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rag&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">faq</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;, defaultValue = &quot;抗日战争的政治目的&quot;)</span> String message)</span> &#123;</span><br><span class="line">        List&lt;Document&gt; similarDocuments = vectorStore.similaritySearch(SearchRequest.query(message).withTopK(<span class="number">2</span>));</span><br><span class="line">        List&lt;String&gt; contentList = similarDocuments.stream().map(Document::getContent).toList();</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(</span><br><span class="line">                ragPromptTemplate, Map.of(<span class="string">&quot;input&quot;</span>, message, <span class="string">&quot;documents&quot;</span>, String.join(<span class="string">&quot;\n&quot;</span>, contentList)));</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(promptTemplate.createMessage());</span><br><span class="line">        <span class="keyword">return</span> chatModel.call(prompt).getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本篇文章使用《论持久战》作为知识，分别向无个人知识库和有个人知识库的 AI 询问“抗日战争的政治目的是什么”，可以发现有个人知识库的 AI 会从知识库中查找答案，回答会更加准确。</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/rag%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<p>如果使用校规、公司规章制度等作为个人知识库，回答效果会更加显著。</p>
<h2 id="流式传输"><a class="header-anchor" href="#流式传输">¶</a>流式传输</h2>
<p>之前的对话方式使用的均是阻塞式聊天调用，一般来说，由于网络请求或 AI 生成的文本过长等因素，会导致等待时间过长、延迟过大，大幅降低用户的体验。</p>
<p>而目前对于对话式的应用场景，主流的调用方式基本采用的是流式对话。什么是流式对话呢？我们常使用的 ChatGPT 使用的就是流式对话，其核心是流式传输，AI 的响应数据是一点一点传过来的，不用等 AI 将文本全部生成出来了才传过来，这在一定程度上能够提高使用上的响应速度。</p>
<p>OpenAI 官网采用的流式传输是由 <strong>SSE</strong> 实现的，这是一种基于 Http 实现的一种服务端向客户端推送消息的技术。</p>
<p>进行流式传输需要使用到 <code>StreamingChatModel</code> 类，具体实现如下面代码所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StreamController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/stream&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">generateStream</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;, defaultValue = &quot;Tell a story&quot;)</span> String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(message).flatMapSequential(Flux::just);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意 <code>@GetMapping</code> 注解中的参数 <code>produces = MediaType.TEXT_EVENT_STREAM_VALUE</code> 不能省去，否则无法实现流式传输。</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/stream%E6%95%88%E6%9E%9C.png" alt="流式传输成功"></p>
<h2 id="上下文对话"><a class="header-anchor" href="#上下文对话">¶</a>上下文对话</h2>
<p>上下文对话的作用就是让 AI 具有记忆力，在之前的对话中，我们是通过一种单一输入输出方式进行调用的，这种调用方式无法让 AI 具有记忆力。</p>
<p>因此，这就要求我们实现一个可以让 ChatGPT 具有一定的记忆力，并根据过去的聊天信息进行回复。</p>
<p>ChatGPT 上下文对话的实现原理较为简单，本质上其实就是将不同角色的聊天信息依次存储在一个队列中发送给 ChatGPT 即可，然后 ChatGPT 会根据整个聊天信息对回复内容进行判断。在 OpenAI 提供的接口中，每条信息的角色总共分为三类：</p>
<ul>
<li><code>SystemMessage</code>：系统限制信息，这种信息在对话中的权重很大，AI 会优先依据 <code>SystemMessage</code> 里的内容进行回复</li>
<li><code>UserMessage</code>：用户信息</li>
<li><code>AssistantMessage</code>：AI 回复信息</li>
</ul>
<p>如果我们需要实现上下文对话，就只需要使用一个 <code>List</code> 存储这些 <code>Message</code> 对象，并将这些 <code>Message</code> 对象一并发送给 AI，AI 拿到这些 <code>Message</code> 后，会根据 <code>Message</code> 里的内容进行回复。</p>
<p>不过，根据 OpenAI 的计费规则，你的消息队列越长，单次问询需要的费用就会越高，因此我们需要对这个消息列表的长度进行限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史消息列表</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;Message&gt; historyMessage = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史消息列表的最大长度</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">maxLen</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ContextController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/context&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">context</span><span class="params">(String prompt)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户输入的文本是UserMessage</span></span><br><span class="line">        historyMessage.add(<span class="keyword">new</span> <span class="title class_">UserMessage</span>(prompt));</span><br><span class="line">        <span class="comment">// 发给AI前对历史消息对列的长度进行检查</span></span><br><span class="line">        <span class="keyword">if</span>(historyMessage.size() &gt; maxLen)&#123;</span><br><span class="line">                historyMessage = historyMessage.subList(historyMessage.size()-maxLen-<span class="number">1</span>,historyMessage.size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取AssistantMessage</span></span><br><span class="line">            <span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> chatModel.call(<span class="keyword">new</span> <span class="title class_">Prompt</span>(historyMessage));</span><br><span class="line">            <span class="type">AssistantMessage</span> <span class="variable">assistantMessage</span> <span class="operator">=</span> chatResponse.getResult().getOutput();</span><br><span class="line">            <span class="comment">// 将AI回复的消息放到历史消息列表中</span></span><br><span class="line">            historyMessage.add(assistantMessage);</span><br><span class="line">            <span class="keyword">return</span> assistantMessage.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如图所示，AI 已经能够对聊天历史进行记忆：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/context%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h2 id="AGENT"><a class="header-anchor" href="#AGENT">¶</a>AGENT</h2>
<p>AI Agent（人工智能代理）是一种能够感知环境、进行决策和执行动作的智能实体。不同于传统的人工智能，AI Agent 具备通过独立思考、调用工具去逐步实现给定目标的能力。</p>
<p>AI Agents = 任务规划（来自 LLM）+ 记忆 + 各类协作工具（访问外部资源）+ 执行/反馈。函数调用（<em>Function Calling</em>）的整体流程可如下图所示：</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/functioncall.jpeg" alt="函数调用流程"></p>
<p>在该部分，我们希望 AI 能够通过调用 <a target="_blank" rel="noopener" href="https://www.weatherapi.com">weather api</a> 去根据用户的提问查询天气，并给出回复。首先，我们需要获得 <a target="_blank" rel="noopener" href="https://www.weatherapi.com">weather api</a> 的 <code>api-key</code> 及 <code>api-url</code>，并在 <em>application.yml</em> 中增加如下字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">weather:</span></span><br><span class="line">  <span class="attr">api-key:</span> <span class="string">$&#123;WEATHER_API_KEY&#125;</span></span><br><span class="line">  <span class="attr">api-url:</span> <span class="string">http://api.weatherapi.com/v1</span></span><br></pre></td></tr></table></figure>
<p>此处 <code>api-key</code> 依然使用环境变量进行配置。</p>
<p>之后，我们创建 Controller 类，进行功能的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FunctionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FunctionController</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/func&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">funcFaq</span><span class="params">(<span class="meta">@RequestParam(value = &quot;message&quot;)</span> String message)</span> &#123;</span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatModel.call(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Prompt</span>(message, OpenAiChatOptions.builder().withFunction(<span class="string">&quot;currentWeather&quot;</span>).build()));</span><br><span class="line">        <span class="keyword">return</span> response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用到了 <code>Prompt</code> 类的构造函数 <code>Prompt(String contents, ChatOptions modelOptions)</code>，通过 <code>ChatOptions</code> 的 <code>.withFunction(&quot;currentWeather&quot;)</code> 确定我们需要调用的 <code>Bean</code> 为 <code>currentWeather</code>。</p>
<p>在 Service 类中，继承了 <code>Function</code> 接口，确定了调用第三方接口时请求体 <code>Request</code> 和响应体 <code>Response</code> 的格式，并通过 <code>apply</code> 方法完成接口调用的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherService</span> <span class="keyword">implements</span> <span class="title class_">Function</span>&lt;WeatherService.Request, WeatherService.Response&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(WeatherService.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> RestClient restClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeatherConfig weatherConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WeatherService</span><span class="params">(WeatherConfig weatherConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.weatherConfig = weatherConfig;</span><br><span class="line">        <span class="built_in">this</span>.restClient = RestClient.create(weatherConfig.apiUrl());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Request</span><span class="params">(String location)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Response</span><span class="params">(Location location, Current current)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Location</span><span class="params">(String name, String region, String country, Long lat, Long lon)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Current</span><span class="params">(String temp_f, Condition condition, String width_mph, String humidity)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Condition</span><span class="params">(String text)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">apply</span><span class="params">(Request request)</span> &#123;  <span class="comment">// 调用第三方接口</span></span><br><span class="line">        log.info(<span class="string">&quot;Using Weather API&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> restClient</span><br><span class="line">                .get()</span><br><span class="line">                .uri(<span class="string">&quot;/current.json?key=&#123;key&#125;&amp;q=&#123;q&#125;&quot;</span>, weatherConfig.apiKey(), request.location)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .body(Response.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过 <em>weatherConfig.java</em> 来将 yml 文件中设置的 <code>api-key</code> 及 <code>api-url</code> 传入 Service 类中，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(value = &quot;weather&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">WeatherConfig</span><span class="params">(String apiKey, String apiUrl)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**注意：**对应的，还需要在启动类上增加注释 <code>@EnableConfigurationProperties(WeatherConfig.class)</code>！</p>
<p>最后，通过在 <code>FunctionConfig.java</code> 中声明一个 <code>Bean</code> ，名字要与 Controller 类中使用到的 <code>.withFunction(&quot;currentWeather&quot;)</code> 中的一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FunctionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeatherConfig weatherConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FunctionConfig</span><span class="params">(WeatherConfig weatherConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.weatherConfig = weatherConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Description(&quot;Get the current weather in location&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Function&lt;WeatherService.Request, WeatherService.Response&gt; currentWeather() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeatherService</span>(weatherConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当询问 AI 相关信息时，它便会决定是否要调用工具，并返回对应的值，比如，我们询问 AI “北京天气怎么样” 时，他便可以给出正确的结果。</p>
<p><img src="https://loong-blogs.oss-cn-beijing.aliyuncs.com/spring_ai/func%E6%95%88%E6%9E%9C.png" alt="效果"></p>
<h2 id="参考文章"><a class="header-anchor" href="#参考文章">¶</a>参考文章</h2>
<p>SpringAI 官网 - <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/index.html">Spring AI</a></p>
<p>Bilibili - <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV11U411d7dP/?spm_id_from=333.880.my_history.page.click&amp;vd_source=738151acb85f4e006a90798faab4e902">Java大模型专栏- Spring AI 入门</a></p>
<p>CSDN - <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41481367/article/details/136073629?spm=1001.2014.3001.5502">Spring AI - 使用向量数据库实现检索式AI对话</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://gubaleaves.github.io">Loong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://gubaleaves.github.io/2024/07/06/spring_ai/">https://gubaleaves.github.io/2024/07/06/spring_ai/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gubaleaves.github.io" target="_blank">Loong's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/AI/">AI</a><a class="post-meta__tags" href="/tags/SpringAI/">SpringAI</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/08/docker_basic/" title="Docker 基础使用"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker 基础使用</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/03/blog_build_new/" title="博客是怎样建成的"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">博客是怎样建成的</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/07/15/alibaba_code_protocol/" title="阿里巴巴代码规范｜编程规约"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-15</div><div class="title">阿里巴巴代码规范｜编程规约</div></div></a></div><div><a href="/2024/07/08/docker_basic/" title="Docker 基础使用"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-08</div><div class="title">Docker 基础使用</div></div></a></div><div><a href="/2024/09/04/beanutils_copyproperties/" title="copyProperties 避坑指南"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-04</div><div class="title">copyProperties 避坑指南</div></div></a></div><div><a href="/2024/08/07/snowflake_id/" title="雪花算法生成分布式 ID"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-07</div><div class="title">雪花算法生成分布式 ID</div></div></a></div><div><a href="/2024/10/11/sorting_algorithm/" title="排序算法总结"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-11</div><div class="title">排序算法总结</div></div></a></div><div><a href="/2024/07/17/stable_diffusion/" title="Stable Diffusion 基础使用"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-17</div><div class="title">Stable Diffusion 基础使用</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Loong</div><div class="author-info__description">Go for it! Just do it!</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com//Gubaleaves"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chat-Model-%E4%B8%8E-Chat-Client"><span class="toc-number">2.</span> <span class="toc-text">Chat Model 与 Chat Client</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number"></span> <span class="toc-text">Chat Client API</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number"></span> <span class="toc-text">Chat Model API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">配置环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven-%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.</span> <span class="toc-text">Maven 依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#application-yml-%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">application.yml 文件配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">2.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%AF%B9%E8%AF%9D"><span class="toc-number">2.1.</span> <span class="toc-text">简单对话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%AF%B9%E8%AF%9D"><span class="toc-number">2.2.</span> <span class="toc-text">带提示词对话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E5%AF%B9%E8%AF%9D"><span class="toc-number">2.3.</span> <span class="toc-text">模版对话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">限制输出格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%BA%93"><span class="toc-number">2.5.</span> <span class="toc-text">知识库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E4%BC%A0%E8%BE%93"><span class="toc-number">3.</span> <span class="toc-text">流式传输</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AF%B9%E8%AF%9D"><span class="toc-number">4.</span> <span class="toc-text">上下文对话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AGENT"><span class="toc-number">5.</span> <span class="toc-text">AGENT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/11/sorting_algorithm/" title="排序算法总结"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="排序算法总结"/></a><div class="content"><a class="title" href="/2024/10/11/sorting_algorithm/" title="排序算法总结">排序算法总结</a><time datetime="2024-10-11T09:50:00.000Z" title="发表于 2024-10-11 17:50:00">2024-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/04/beanutils_copyproperties/" title="copyProperties 避坑指南"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="copyProperties 避坑指南"/></a><div class="content"><a class="title" href="/2024/09/04/beanutils_copyproperties/" title="copyProperties 避坑指南">copyProperties 避坑指南</a><time datetime="2024-09-04T13:55:00.000Z" title="发表于 2024-09-04 21:55:00">2024-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/01/blog_domain_cdn/" title="博客是怎样优化的｜自定义域名"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="博客是怎样优化的｜自定义域名"/></a><div class="content"><a class="title" href="/2024/09/01/blog_domain_cdn/" title="博客是怎样优化的｜自定义域名">博客是怎样优化的｜自定义域名</a><time datetime="2024-09-01T11:43:00.000Z" title="发表于 2024-09-01 19:43:00">2024-09-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/11/git_rebase/" title="git rebase 使用"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="git rebase 使用"/></a><div class="content"><a class="title" href="/2024/08/11/git_rebase/" title="git rebase 使用">git rebase 使用</a><time datetime="2024-08-11T13:01:14.000Z" title="发表于 2024-08-11 21:01:14">2024-08-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/07/snowflake_id/" title="雪花算法生成分布式 ID"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="雪花算法生成分布式 ID"/></a><div class="content"><a class="title" href="/2024/08/07/snowflake_id/" title="雪花算法生成分布式 ID">雪花算法生成分布式 ID</a><time datetime="2024-08-07T07:26:00.000Z" title="发表于 2024-08-07 15:26:00">2024-08-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By Loong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://leafloong.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://leafloong.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.31/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>